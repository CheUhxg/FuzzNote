# FUZE：为内核UAF漏洞提供利用生成

## 摘要

软件供应商通常会根据其利用的容易程度来确定其缺陷修复的优先级。然而，准确确定可利用性通常需要大量时间，并且需要大量的人工工作。为了解决这个问题，可以采用自动利用生成技术。然而，在实践中，它们显示出足够的能力来评估可利用性，特别是针对UAF漏洞。这主要是因为UAF利用的复杂性以及OS内核的可扩展性。

因此，在本文中，我们提出了一种新的框架FUZE，以促进内核UAF利用过程。这项技术背后的设计原则是，我们希望利用漏洞的简易性可以帮助安全分析师评估内核UAF漏洞的可利用性。从技术上讲，FUZE利用内核fuzzing和符号执行来识别、分析和评估系统调用，这些调用对内核UAF利用有用。此外，它利用动态跟踪和现成的约束控制器（TODO:constraint solver）来指导易受攻击对象的操作。

为了演示FUZE的实用性，我们通过扩展二进制分析框架和内核模糊器在64位Linux系统上实现了FUZE。通过在Linux系统上使用15个真实世界内核UAF漏洞，进而演示FUZE不仅可以提高内核UAF的可利用性，还可以使可利用性多样化。此外，我们还表明，FUZE可以促进安全缓解绕过，使可利用性评估更具挑战性和效率。

## 一、引言

对于一个软件团队来说，拥有足够的资源来解决每一个软件错误是非常罕见的。因此，微软和Ubuntu等软件供应商设计并制定了各种策略，以确定修复工作的优先级。在所有这些策略中，具有可利用性的补救优先级是最常见的策略，它基于软件包的易利用性来评估软件包。然而，在实践中，确定可利用性是一个复杂而漫长的过程，特别是对于那些驻留在OS内核中的UAF漏洞。

UAF漏洞是一种特殊的内存损坏漏洞，它可能会损坏有效数据，从而可能导致任意代码的执行。当发生在OS内核中时，它们还可能导致提权和关键数据泄漏。为了利用这些漏洞，特别是在OS内核中，攻击者需要手动查明释放对象（即易受攻击的对象）发生的时间帧，以便将数据喷洒到其区域，并据此修改其内容。为了确保操作系统内核的安全执行会受到喷洒数据的影响，他还需要利用自己的专业知识，根据释放对象的大小以及堆分配器的类型，手动调整系统调用和相应的参数。我们在第2节中通过一个具体的例子来展示这个过程。

为了促进可利用性评估，本能的反应是借助为利用生成提出的研究工作，其中程序分析技术通常用于分析程序故障并相应地产生利用。然而，所提出的技术不足以解决上述问题。一方面是因为用于利用生成的程序分析技术*仅适用于简单程序*，而不适用于具有更高复杂性和可扩展性的OS内核。另一方面是因为他们的技术方法*主要集中在栈或堆溢出漏洞上*，通过简单地改变PoC程序的上下文就可能有助于利用这些漏洞，因为UAF漏洞的利用需要对易受攻击对象进行空间和时间控制，在这些约束条件下，微小的上下文变化通常不利于可利用性探索。

在这项工作中，我们提出了FUZE，一个评估内核UAF漏洞可利用性的攻击框架。原则上，该框架类似于先前提出的技术方法，通过自动探索漏洞的可利用性来实现可利用性评估。从技术上讲，我们的框架遵循完全不同的设计，它利用fuzzing技术使<u>内核恐慌的上下文</u>多样化，然后利用符号执行来探索不同上下文中的可利用性。

更具体地说，我们的系统首先将一个PoC程序作为输入，该程序不执行利用，但会导致内核恐慌。然后，它利用内核fuzzing来探索各种系统调用，从而改变内核恐慌的上下文。在每个环境下，每一个不同的内核恐慌，FUZE进一步执行符号执行的目标是追踪潜在的有用的原语利用。为了找出真正有价值的UAF漏洞利用甚至绕过安全缓解的原语，FUZE总结了一套常用的利用方法，然后利用它们对原语进行相应的评估。在第3节中，我们将详细描述这个利用框架。

与现有的技术不同，提出的利用框架不是为了实现完全自动化的利用生成。相反地，它通过简化利用制造过程来促进可利用性评估。更具体地说，FUZE从以下几个方面促进了利用制造。

首先，它增强了安全分析师**自动化识别系统调用**的能力，他需要利用这些系统调用进行UAF漏洞利用。其次，它允许安全分析师**自动计算他需要喷洒到脆弱对象区域的数据**。第三，它有助于安全分析人员**确定需要执行堆喷洒和漏洞利用的时间范围**。第四，它为安全分析人员提供了实现**安全缓解绕过**的能力。

正如我们将在第6节中所展示的，在上述所有方面的促进下，我们不仅可以升级内核UAF的可用性，而且还可以从各种内核恐慌中使可用性多样化。另外，我们证明，FUZE甚至可以帮助安全分析师设计漏洞，绕过广泛部署的安全缓解措施，如SMEP和SMAP。据我们所知，FUZE是第一个能够促进内核UAF漏洞可用性评估的开发框架。

综上所述，本文有以下几点贡献。
* 我们设计了FUZE，一个利用内核fuzzing和符号执行来促进内核UAF开发的开发框架。
* 通过在64位Linux系统上扩展二进制分析框架和内核fuzzer，我们实现了FUZE以促进漏洞生成过程。
* 我们通过在Linux内核中使用15个真实的UAF漏洞，演示了FUZE在制作可运行利用以及促进安全规避方面的效用。

本文的其余部分组织如下。第二节介绍了我们研究的背景和所面临的挑战。第三节是FUZE的概述。第四节详细介绍了FUZE的设计。第五节介绍FUZE的实现，第六节演示FUZE的实用性。第七节总结了与我们最相关的工作。最后，我们在第八节对本文的工作进行了总结。

## 二、背景和挑战

为了利用驻留在操作系统内核中的UAF漏洞，安全分析师需要分析一个PoC程序，该程序演示了一个带有内核恐慌的UAF漏洞，但没有利用真正的目标。从该程序中，他通常需要采取以下步骤，以执行成功的开发。

![](image/figure1.png)

首先，安全分析人员需要确定*导致悬浮指针出现*以及*解引用该指针*的系统调用(参见图1中的1)。其次，他需要根据对象的大小和堆分配器的类型分析悬浮指针指向的释放对象。因此，他可以<u>在与悬浮指针的出现和解引用相关联的时间框架内</u>确定*执行堆喷洒的*系统调用(参见图1中的2)。

一般来说，堆喷洒的目标是**接管释放的对象**，从而利用所喷洒的数据将系统的控制流重定向到未经授权的操作，例如特权升级或关键数据泄漏。因此，安全分析人员还需要根据PoC程序的语义仔细计算所喷洒数据的内容，从而调整为执行堆喷洒而选择的系统调用的参数，然后才最终修改以手动方式利用的PoC程序。正如在3和4中指定的那样，我们在图1中描述了最后一步。

在过去，研究主要关注如何增强安全分析人员的能力，使其能够选择系统调用并执行有效的堆喷洒(例如，促进图1中所示的步骤2)。在某种程度上，这确实促进了开发利用的过程。然而，通过简单地遵循上面提到的典型工作流以及步骤2的帮助，对于安全分析师来说，为实际的UAF漏洞设计一个可运行利用仍然是具有挑战性的，而且通常是不可实现的。正如我们将在下面通过一个真实的UAF漏洞详细说明的那样，这是因为PoC程序几乎没有提供有用的运行上下文，只有在此背景下，安全分析人员菜可以成功地执行利用。

### 内核UAF漏洞的PoC程序

