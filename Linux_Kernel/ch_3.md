# 第三章 进程管理

## 进程

进程就是处于执行期的程序。
* 进程=代码段+数据段+打开的文件+挂起的信号+内核内部数据+处理器状态+具有内存映射的内存地址空间+线程。

线程是进程中活动的对象。
* 每个线程都有一个独立的程序计数器、进程栈和一组进程寄存器。
* Linux的线程实现中**不区分线程和进程**，将线程视为特殊的进程。

进程提供两种虚拟机制。
* 虚拟处理器：让进程认为自己独占处理器。
* 虚拟内存：让进程认为自己拥有整个系统的所有内存资源。

> 线程之间可以共享虚拟内存，但是虚拟处理器独立。

Linux系统使用fork()派生新进程。
* fork()返回两次：分别回到父进程和子进程。
* fork()实际上是由clone()系统调用完成的。

一个进程退出后进入**僵死状态**，直到其父进程调用wait()或waitpid()。

## 进程描述符

内核将进程的列表放在**任务队列**中。
* 任务队列是一个**双向循环链表**，链表节点的类型是task_struct，被称作进程描述符。
* task_struct在linux/sched.h中被定义，包含了**内核管理一个进程所需的所有信息**。

### 分配进程描述符

Linux使用**slab分配器**分配task_struct结构。
* 这是为了达到**对象复用**和**缓存着色**的目的。
* slab分配器动态生成task_struct，即**在内核栈的尾端自高向低创建一个新的thread_info结构体**，其中会包括进程描述符的地址。

### 进程描述符的存放

内核通过一个唯一的PID来标识每个进程。
* PID是一个数，类型为pid_t（实际上就是int），默认最大值为32768。
* PID放在各自的进程描述符中。
* 最大值可以通过/proc/sys/kernel/pid_max来修改。

内核访问任务需要获得指向其task_struct的指针。
* 内核通过current宏查找当前运行进程的进程描述符，所以这个过程的速度很重要。
  * 有的体系结构可以给出专门的寄存器来存放进程描述符的指针。
  * x86寄存器不够，只能通过偏移间接计算task_struct结构的地址。